<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Video JS CSS -->
    <link href="https://unpkg.com/video.js@7.10.2/dist/video-js.min.css" rel="stylesheet">

    <!-- Video JS -->
    <script src="https://unpkg.com/video.js@7.10.2/dist/video.min.js"></script>
    <script src="https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.js"></script>

    <title>Last View</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KTTH441JJJ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-KTTH441JJJ');
    </script>
</head>

<body>
    <div class="container-fluid d-flex flex-column p-0" style="height: 100vh;overflow:hidden">
        <div class="row bg-dark d-flex justify-content-between align-items-center">
            <div class="col text-white ms-2">Turun Tuomiokirkko</div>
            <div class="col text-center">
                <button type="button" onclick="switchCamera(0)" class="btn btn-sm btn-secondary rounded-0 cam-btn"
                    id="cam-btn-1">Camera 1</button>
                <button type="button" onclick="switchCamera(1)" class="btn btn-sm btn-secondary rounded-0 cam-btn"
                    id="cam-btn-2">Camera 2</button>
            </div>
            <div class="col text-end me-2">
                <span class="text-white" id="status-offline">OFFLINE</span>
                <span class="text-danger" id="status-online"><span class="blink">⬤</span> LIVE</span>
            </div>
        </div>
        <div class="row" style="flex:1">
            <div class="col d-flex">
                <video-js id="vid1" style="flex:1;height:100%" class="vjs-default-skin flex-1" controls>
                    <source id="video-source" src="https://camera1.stream.laval.fi/hls/stream.m3u8" type="application/x-mpegURL">
                </video-js>
            </div>
        </div>
        <div class="row bg-dark">
            <div class="col-8 ms-2">
                <button type="button" onclick="goToPreset(1)" class="preset btn btn-sm btn-secondary rounded-0"
                    id="loc-btn-1">Location 1</button>
                <button type="button" onclick="goToPreset(2)" class="preset btn btn-sm btn-secondary rounded-0"
                    id="loc-btn-2">Location 2</button>
                <button type="button" onclick="goToPreset(3)" class="preset btn btn-sm btn-secondary rounded-0"
                    id="loc-btn-3">Location 3</button>
                <button type="button" onclick="goToPreset(4)" class="preset btn btn-sm btn-secondary rounded-0"
                    id="loc-btn-4">Location 4</button>
            </div>
            <div class="col text-end text-white me-2">
                <small>Current control delay 20-30 seconds.</small>
            </div>
        </div>
    </div>

    <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center w-100"
        style="position:absolute;top:0;left:0;width:100vw;height:100vh;pointer-events: none;">

        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Alert</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Whoa there cowboy, slow down your clicking finger.
            </div>
        </div>
    </div>

    <style>
        .blink {
            animation: blink 2s cubic-bezier(.5, 0, 1, 1) infinite alternate;
        }

        @keyframes blink {
            to {
                opacity: 0;
            }
        }

        #status-offline {
            display: none;
        }

        #status-online {
            display: block;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <script>
        // Initialize player
        var player = videojs('vid1');

        var sourceUrls = [
            'https://camera1.stream.laval.fi/hls/stream.m3u8',
            'https://camera2.stream.laval.fi/hls/stream.m3u8'
        ];

        // Set active camera to Camera 2 by default
        var activeCamera = 1;

        var cameras = [
            {
                locations: [
                    {
                        label: 'Vanha Suurtori'
                    },
                    {
                        label: 'Vartiovuori'
                    },
                    {
                        label: 'Brahenpuisto'
                    },
                    {
                        label: 'Aurajoki'
                    }
                ]
            },
            {
                locations: [
                    {
                        label: 'Keskusta'
                    },
                    {
                        label: 'Pääkirjasto'
                    },
                    {
                        label: 'Aurajoki'
                    },
                    {
                        label: 'Kauppatori'
                    }
                ]
            }
        ];

        function setLabels() {
            cameras[activeCamera].locations.forEach((location, index) => {
                document.getElementById(`loc-btn-${index + 1}`).innerText = location.label;
            });
        }

        function switchCamera(camera) {
            activeCamera = camera;

            var camButtons = [].slice.call(document.getElementsByClassName(`cam-btn`));
            camButtons.forEach(btn => btn.classList.remove('active'));

            document.getElementById(`cam-btn-${camera + 1}`).classList.add('active');

            player.src({ type: 'application/x-mpegURL', src: sourceUrls[camera] });
            player.play();

            setLabels();
        }

        function goToPreset(presetValue) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", remoteUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "action": "PRESET",
                "target": activeCamera,
                "value": presetValue
            }));

            xhr.onload = function (response, err) {
                var state = xhr.status;
                if (state === 201) {
                    console.log('Request received.');
                }
                if (state === 403) {
                    console.error('Permission denied.');
                }
                if (state === 429) {
                    console.error('Too many requests, slow down cowboy...')

                    var toastEl = document.getElementById('toast');
                    var toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
            }

            xhr.onerror = function () {
                var state = xhr.status;
                console.log('Error received', state);
            }
        }

        window.onload = function () {
            document.getElementById('cam-btn-2').classList.add('active');

            // Päivitetään videon lähde elementti
            var videoSource = document.getElementById('video-source');
            videoSource.src = sourceUrls[1];

            // Päivitetään video.js player
            player.src({ type: 'application/x-mpegURL', src: sourceUrls[1] });
            player.ready(function () {
                this.play();
            });

            setLabels();
        };
    </script>

</body>

</html>
